apiVersion: "nuclio.io/v1beta1"
kind: "NuclioFunction"
metadata:
  name: sensorvaluesfunction
spec:
  description: >
    Simply function that gets sensor values, generate log and sends it to topics.
  runtime: "python:3.6"
  handler: "main:handler"
  minReplicas: 1
  maxReplicas: 1
  triggers:
    myNatsTopic:
      kind: "rabbit-mq"
      url: "amqp://admin:serverlessistheway@192.168.56.1:5672"
      attributes:
        exchangeName: "topic.sensors"
        queueName: "sensor_values"
  build:
    commands:
    - "pip install pika"
    functionSourceCode: "ZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHBpa2EKCgpkZWYgc2VuZF9tZXNzYWdlKGNoYW5uZWwsIHF1ZXVlLCBkYXRhKToKICAgIGNoYW5uZWwucXVldWVfZGVjbGFyZShxdWV1ZT1xdWV1ZSkKICAgIGNoYW5uZWwuYmFzaWNfcHVibGlzaChleGNoYW5nZT0nJywKICAgICAgICAgICAgICAgICAgICAgICAgICByb3V0aW5nX2tleT1xdWV1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICBib2R5PWJ5dGVzKGRhdGEsIGVuY29kaW5nPSd1dGY4JykpCgoKZGVmIGNyZWF0ZV9jb25uZWN0aW9uKCk6CiAgICBjcmVkZW50aWFscyA9IHBpa2EuUGxhaW5DcmVkZW50aWFscygiYWRtaW4iLCAic2VydmVybGVzc2lzdGhld2F5IikKICAgIGNvbm5lY3Rpb24gPSBwaWthLkJsb2NraW5nQ29ubmVjdGlvbigKICAgICAgICBwaWthLkNvbm5lY3Rpb25QYXJhbWV0ZXJzKGhvc3Q9JzE5Mi4xNjguNTYuMScsIHBvcnQ9NTY3MiwgY3JlZGVudGlhbHM9Y3JlZGVudGlhbHMpKQogICAgcmV0dXJuIGNvbm5lY3Rpb24uY2hhbm5lbCgpCgoKZGVmIGdldF9kYW5nZXIoeCk6CiAgICByZXR1cm4gKHggLSAyMDApICogKDMgLSAxKSAvICgxMDAwIC0gMjAwKSArIDEKCgpkZWYgZ2VuZXJhdGVfbWVzc2FnZShkYW5nZXIsIGJvZHkpOgogICAgaWYgZGFuZ2VyID09IDE6CiAgICAgICAgc2V2ZXJpdHkgPSAiTE9XIgogICAgZWxpZiBkYW5nZXIgPT0gMjoKICAgICAgICBzZXZlcml0eSA9ICJNRURJVU0iCiAgICBlbGlmIGRhbmdlciA9PSAzOgogICAgICAgIHNldmVyaXR5ID0gIkhJR0giCiAgICBlbHNlOgogICAgICAgIHNldmVyaXR5ID0gIkVSUk9SIgoKICAgIG5vdyA9IGRhdGV0aW1lLm5vdygpCiAgICBkdF9zdHJpbmcgPSBub3cuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikKICAgIHJldHVybiBmIklORk8gLSBEYW5nZXI6IHtzZXZlcml0eX0gLSBTZW5zb3IgdmFsdWU6IHtib2R5fSAtIERhdGU6IHtkdF9zdHJpbmd9IgoKCmRlZiBoYW5kbGVyKGNvbnRleHQsIGV2ZW50KToKICAgIGJvZHkgPSBpbnQoZXZlbnQuYm9keS5kZWNvZGUoKSkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZidSZWNlaXZlZCBib2R5OiB7Ym9keX0nKQogICAgZGFuZ2VyID0gaW50KGdldF9kYW5nZXIoYm9keSkpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYnRGFuZ2VyIGJvZHk6IHtkYW5nZXJ9JykKICAgIG1lc3NhZ2UgPSBnZW5lcmF0ZV9tZXNzYWdlKGRhbmdlciwgYm9keSkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZidHZW5lcmF0ZWQgbWVzc2FnZToge21lc3NhZ2V9JykKICAgIGNoYW5uZWwgPSBjcmVhdGVfY29ubmVjdGlvbigpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdTZW5kaW5nIG1lc3NhZ2UgZm9yIGxvZyBxdWV1ZScpCiAgICBzZW5kX21lc3NhZ2UoY2hhbm5lbCwgImxvZyIsIG1lc3NhZ2UpCiAgICBpZiBkYW5nZXIgPT0gNDoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdTZW5kaW5nIG1lc3NhZ2UgZm9yIG5vdGlmaWNhdGlvbiBxdWV1ZScpCiAgICAgICAgc2VuZF9tZXNzYWdlKGNoYW5uZWwsICJub3RpZmljYXRpb24iLCBtZXNzYWdlKQogICAgcmV0dXJuCg==="

