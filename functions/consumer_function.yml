apiVersion: "nuclio.io/v1beta1"
kind: "NuclioFunction"
metadata:
  name: sensorvaluesfunction
spec:
  description: >
    Simply function that gets sensor values, generate log and sends it to topics.
  runtime: "python:3.6"
  handler: "main:handler"
  minReplicas: 1
  maxReplicas: 1
  triggers:
    myNatsTopic:
      kind: "rabbit-mq"
      url: "amqp://admin:serverlessistheway@192.168.56.1:5672"
      attributes:
        exchangeName: "topic.sensors"
        queueName: "sensor_values"
  build:
    commands:
      - "pip install pika"
    functionSourceCode: "ZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHBpa2EKCmRlZiBzZW5kX21lc3NhZ2UoY2hhbm5lbCwgcXVldWUsIGRhdGEpOgogICAgY2hhbm5lbC5xdWV1ZV9kZWNsYXJlKHF1ZXVlPXF1ZXVlKQogICAgY2hhbm5lbC5iYXNpY19wdWJsaXNoKGV4Y2hhbmdlPScnLAogICAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRpbmdfa2V5PXF1ZXVlLAogICAgICAgICAgICAgICAgICAgICAgICAgIGJvZHk9Ynl0ZXMoZGF0YSwgZW5jb2Rpbmc9J3V0ZjgnKSkKCgpkZWYgY3JlYXRlX2Nvbm5lY3Rpb24oKToKICAgIGNyZWRlbnRpYWxzID0gcGlrYS5QbGFpbkNyZWRlbnRpYWxzKCJhZG1pbiIsICJzZXJ2ZXJsZXNzaXN0aGV3YXkiKQogICAgY29ubmVjdGlvbiA9IHBpa2EuQmxvY2tpbmdDb25uZWN0aW9uKAogICAgICAgIHBpa2EuQ29ubmVjdGlvblBhcmFtZXRlcnMoaG9zdD0nMTkyLjE2OC41Ni4xJywgcG9ydD01NjcyLCBjcmVkZW50aWFscz1jcmVkZW50aWFscykpCiAgICByZXR1cm4gY29ubmVjdGlvbi5jaGFubmVsKCkKCgpkZWYgZ2V0X2Rhbmdlcih4KToKICAgIHJldHVybiAoeCAtIDIwMCkgKiAoMyAtIDEpIC8gKDEwMDAgLSAyMDApICsgMQoKCmRlZiBnZW5lcmF0ZV9tZXNzYWdlKGRhbmdlciwgYm9keSk6CiAgICBpZiBkYW5nZXIgPT0gMToKICAgICAgICBzZXZlcml0eSA9ICJMT1ciCiAgICBlbGlmIGRhbmdlciA9PSAyOgogICAgICAgIHNldmVyaXR5ID0gIk1FRElVTSIKICAgIGVsaWYgZGFuZ2VyID09IDM6CiAgICAgICAgc2V2ZXJpdHkgPSAiSElHSCIKICAgIGVsc2U6CiAgICAgICAgc2V2ZXJpdHkgPSAiRVJST1IiCgogICAgbm93ID0gZGF0ZXRpbWUubm93KCkKICAgIGR0X3N0cmluZyA9IG5vdy5zdHJmdGltZSgiJWQvJW0vJVkgJUg6JU06JVMiKQogICAgcmV0dXJuIGYiSU5GTyAtIERhbmdlcjoge3NldmVyaXR5fSAtIFNlbnNvciB2YWx1ZToge2JvZHl9IC0gRGF0ZToge2R0X3N0cmluZ30iCgoKZGVmIGhhbmRsZXIoY29udGV4dCwgZXZlbnQpOgogICAgYm9keSA9IGludChldmVudC5ib2R5LmRlY29kZSgpKQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ1JlY2VpdmVkIGJvZHk6IHtib2R5fScpCiAgICBkYW5nZXIgPSBpbnQoZ2V0X2Rhbmdlcihib2R5KSkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZidEYW5nZXIgYm9keToge2Rhbmdlcn0nKQogICAgbWVzc2FnZSA9IGdlbmVyYXRlX21lc3NhZ2UoZGFuZ2VyLCBib2R5KQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ0dlbmVyYXRlZCBtZXNzYWdlOiB7bWVzc2FnZX0nKQogICAgY2hhbm5lbCA9IGNyZWF0ZV9jb25uZWN0aW9uKCkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ1NlbmRpbmcgbWVzc2FnZSBmb3IgbG9nIHF1ZXVlJykKICAgIHNlbmRfbWVzc2FnZShjaGFubmVsLCAibG9nIiwgbWVzc2FnZSkKICAgIGlmIGRhbmdlciA9PSAzOgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ1NlbmRpbmcgbWVzc2FnZSBmb3IgYWxhcm0gcXVldWUnKQogICAgICAgIHNlbmRfbWVzc2FnZShjaGFubmVsLCAiYWxhcm0iLCBtZXNzYWdlKQogICAgcmV0dXJuCg=="

